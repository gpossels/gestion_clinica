<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indicadores Semanales</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f4f8;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: white;
            border: 2px solid black;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 { font-size: 2em; margin-bottom: 5px; }
        .header p { color: #555; }
        .header-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .nav-btn {
            background: white;
            border: 2px solid black;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95em;
        }
        .nav-btn:hover { background: #f0f0f0; }
        .nav-btn.rojo { border-color: #dc3545; color: #dc3545; }
        .nav-btn.rojo:hover { background: #f8d7da; }
        .card {
            background: white;
            border: 2px solid black;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        .card h2 {
            font-size: 1.3em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .form-col { flex: 1; min-width: 200px; }
        .form-col label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
        }
        select, input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
            font-family: inherit;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #1a73e8;
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background: #1a73e8; color: white; }
        .btn-primary:hover { background: #1558b0; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .alert {
            padding: 12px 18px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-weight: 500;
            display: none;
        }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .hidden { display: none; }
        .grupo-section { margin-bottom: 30px; }
        .grupo-titulo {
            font-size: 1.2em;
            font-weight: bold;
            color: #1a73e8;
            padding: 10px 0;
            border-bottom: 2px solid #1a73e8;
            margin-bottom: 15px;
        }
        .subgrupo-titulo {
            font-size: 1em;
            font-weight: bold;
            color: #555;
            padding: 8px 0;
            margin-bottom: 10px;
        }
        .indicadores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .indicador-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        .indicador-card:hover {
            border-color: #1a73e8;
            box-shadow: 0 2px 8px rgba(26,115,232,0.15);
        }
        .indicador-card.seleccionado {
            border-color: #1a73e8;
            background: #e8f0fe;
        }
        .indicador-card h4 { font-size: 0.95em; margin-bottom: 5px; }
        .indicador-card p { font-size: 0.8em; color: #888; }
        .chart-container {
            position: relative;
            height: 500px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }
        .chart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .chart-controls button {
            background: #6f42c1;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .chart-controls button:hover { background: #5a359a; }
        .buscador-ind {
            position: relative;
            margin-bottom: 20px;
        }
        .buscador-ind input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #1a73e8;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
        }
        .buscador-ind input:focus { outline: none; }
        #sugerenciasInd {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            max-height: 250px;
            overflow-y: auto;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .sug-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .sug-item:hover { background: #f0f4f8; }
        .sug-item .sug-nombre { font-weight: 600; font-size: 0.95em; }
        .sug-item .sug-meta { font-size: 0.8em; color: #888; }
        .range-controls {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
        }
        .range-controls h4 { margin-bottom: 10px; color: #333; }
        .range-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .range-btn {
            background: #6f42c1;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }
        .range-btn:hover { background: #5a359a; }
        @media (max-width: 768px) {
            .indicadores-grid { grid-template-columns: 1fr; }
            .chart-container { height: 350px; }
        }
    </style>
</head>
<body>
<div class="container">

    <!-- HEADER -->
    <div class="header">
        <h1>üìÖ Indicadores Semanales</h1>
        <p id="headerSubtitle">Gr√°ficos PBC por semana ISO</p>
        <div class="header-actions">
            <button class="nav-btn" onclick="window.location.href='index.html'">‚Üê Inicio</button>
            <button class="nav-btn rojo" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
        </div>
    </div>

    <!-- ALERTA -->
    <div id="alertBox" class="alert"></div>

    <!-- FILTROS -->
    <div class="card">
        <h2>Filtros</h2>
        <div class="form-row">
            <div class="form-col">
                <label>Centro</label>
                <select id="selCentro">
                    <option value="">-- Seleccione centro --</option>
                </select>
            </div>
            <div class="form-col">
                <label>Semana inicio</label>
                <select id="selSemanaInicio"></select>
            </div>
            <div class="form-col">
                <label>A√±o inicio</label>
                <input type="number" id="inputAnioInicio" min="2000" max="2100" value="2024">
            </div>
            <div class="form-col">
                <label>Semana fin</label>
                <select id="selSemanaFin"></select>
            </div>
            <div class="form-col">
                <label>A√±o fin</label>
                <input type="number" id="inputAnioFin" min="2000" max="2100" value="2025">
            </div>
        </div>
    </div>

    <!-- BUSCADOR DE INDICADORES -->
    <div class="card">
        <h2>Seleccionar Indicador</h2>
        <div class="buscador-ind">
            <input type="text" id="inputBuscadorInd" placeholder="Busque por nombre, grupo o subgrupo..." autocomplete="off">
            <div id="sugerenciasInd"></div>
        </div>
        <div id="listaIndicadores"></div>
    </div>

    <!-- GR√ÅFICO -->
    <div class="card hidden" id="panelGrafico">
        <h2 id="tituloGrafico">Gr√°fico PBC</h2>
        <div class="chart-controls">
            <button onclick="toggleYAxis()">Eje Y desde 0</button>
            <button onclick="toggleLabels()">Ocultar Etiquetas</button>
            <button onclick="downloadChart()">Descargar Gr√°fico</button>
            <button onclick="copyChart()">Copiar Gr√°fico</button>
        </div>
        <div class="range-controls">
            <h4>Ventana de Visualizaci√≥n</h4>
            <div class="range-buttons">
                <button class="range-btn" onclick="mostrarTodo()">Mostrar Todo</button>
                <button class="range-btn" onclick="mostrarUltimos24()">√öltimas 24 semanas</button>
            </div>
            <div id="rangeInfo" style="margin-top:10px; font-size:0.9em; color:#555;"></div>
        </div>
        <div class="chart-container">
            <canvas id="pbcChart"></canvas>
        </div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBgxwwm7Q0kf0DgkjZip0rIvobRnXVJUXw",
        authDomain: "indicadores-gestion-clinica.firebaseapp.com",
        projectId: "indicadores-gestion-clinica",
        storageBucket: "indicadores-gestion-clinica.firebasestorage.app",
        messagingSenderId: "1221554815",
        appId: "1:1221554815:web:f304f787f2a953ce59454a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let centros = [];
    let indicadores = [];
    let pbcChart = null;
    let currentResults = null;
    let rangeStart = 1;
    let rangeEnd = 1;
    let yAxisFromZero = false;
    let showLabels = true;
    let indicadorActivo = null;

    // ‚îÄ‚îÄ‚îÄ UTILIDADES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showAlert(msg, type = 'info') {
        const box = document.getElementById('alertBox');
        box.className = `alert alert-${type}`;
        box.textContent = msg;
        box.style.display = 'block';
        setTimeout(() => box.style.display = 'none', 4000);
    }

    function poblarSemanas(selectId) {
        const sel = document.getElementById(selectId);
        sel.innerHTML = '';
        for (let i = 1; i <= 53; i++) {
            const opt = document.createElement('option');
            opt.value = String(i).padStart(2,'0');
            opt.textContent = `Semana ${i}`;
            sel.appendChild(opt);
        }
    }

    function getFechaISO(anio, semana) {
        return `${anio}-W${String(semana).padStart(2,'0')}`;
    }

    function compararFechasISO(a, b) {
        return a.localeCompare(b);
    }

    // ‚îÄ‚îÄ‚îÄ CARGAR DATOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function cargarCentros() {
        const snap = await getDocs(collection(db, 'centros'));
        centros = [];
        snap.forEach(d => centros.push({ id: d.id, ...d.data() }));
        centros.sort((a,b) => a.nombre.localeCompare(b.nombre));

        const sel = document.getElementById('selCentro');
        centros.filter(c => c.activo !== false).forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.nombre;
            sel.appendChild(opt);
        });
    }

    async function cargarIndicadores() {
        const snap = await getDocs(collection(db, 'indicadores_semanales'));
        indicadores = [];
        snap.forEach(d => indicadores.push({ id: d.id, ...d.data() }));
        indicadores.sort((a,b) => a.nombre.localeCompare(b.nombre));
        renderIndicadores(indicadores);
        iniciarBuscador();
    }

    // ‚îÄ‚îÄ‚îÄ RENDER INDICADORES POR GRUPO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderIndicadores(lista) {
        const container = document.getElementById('listaIndicadores');
        container.innerHTML = '';

        if (lista.length === 0) {
            container.innerHTML = '<p style="color:#888;">No se encontraron indicadores.</p>';
            return;
        }

        // Agrupar por grupo y subgrupo
        const grupos = {};
        lista.forEach(ind => {
            const g = ind.grupo || 'Sin grupo';
            const sg = ind.subgrupo || 'General';
            if (!grupos[g]) grupos[g] = {};
            if (!grupos[g][sg]) grupos[g][sg] = [];
            grupos[g][sg].push(ind);
        });

        Object.keys(grupos).sort().forEach(grupo => {
            const seccion = document.createElement('div');
            seccion.className = 'grupo-section';

            const tituloGrupo = document.createElement('div');
            tituloGrupo.className = 'grupo-titulo';
            tituloGrupo.textContent = grupo;
            seccion.appendChild(tituloGrupo);

            Object.keys(grupos[grupo]).sort().forEach(subgrupo => {
                const tituloSub = document.createElement('div');
                tituloSub.className = 'subgrupo-titulo';
                tituloSub.textContent = subgrupo;
                seccion.appendChild(tituloSub);

                const grid = document.createElement('div');
                grid.className = 'indicadores-grid';

                grupos[grupo][subgrupo].forEach(ind => {
                    const card = document.createElement('div');
                    card.className = 'indicador-card';
                    card.id = `ind_${ind.id}`;
                    card.innerHTML = `
                        <h4>${ind.nombre}</h4>
                        <p>${ind.campo_numerador}${ind.campo_denominador ? ' √∑ ' + ind.campo_denominador : ''} √ó ${ind.multiplicador}</p>
                    `;
                    card.addEventListener('click', () => seleccionarIndicador(ind));
                    grid.appendChild(card);
                });

                seccion.appendChild(grid);
            });

            container.appendChild(seccion);
        });
    }

    // ‚îÄ‚îÄ‚îÄ BUSCADOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function iniciarBuscador() {
        const input = document.getElementById('inputBuscadorInd');
        const sugerencias = document.getElementById('sugerenciasInd');

        input.addEventListener('input', function() {
            const texto = this.value.toLowerCase().trim();

            if (texto.length < 1) {
                sugerencias.style.display = 'none';
                renderIndicadores(indicadores);
                return;
            }

            const coincidencias = indicadores.filter(ind =>
                ind.nombre.toLowerCase().includes(texto) ||
                (ind.grupo || '').toLowerCase().includes(texto) ||
                (ind.subgrupo || '').toLowerCase().includes(texto)
            );

            renderIndicadores(coincidencias);

            if (coincidencias.length === 0) {
                sugerencias.style.display = 'none';
                return;
            }

            sugerencias.innerHTML = '';
            sugerencias.style.display = 'block';

            coincidencias.slice(0, 8).forEach(ind => {
                const item = document.createElement('div');
                item.className = 'sug-item';
                item.innerHTML = `
                    <div class="sug-nombre">${ind.nombre}</div>
                    <div class="sug-meta">${ind.grupo || ''}${ind.subgrupo ? ' ‚Ä∫ ' + ind.subgrupo : ''}</div>
                `;
                item.addEventListener('click', () => {
                    seleccionarIndicador(ind);
                    input.value = '';
                    sugerencias.style.display = 'none';
                    renderIndicadores(indicadores);
                });
                sugerencias.appendChild(item);
            });
        });

        document.addEventListener('click', e => {
            if (!e.target.closest('.buscador-ind')) sugerencias.style.display = 'none';
        });
    }

    // ‚îÄ‚îÄ‚îÄ SELECCIONAR INDICADOR Y GENERAR GR√ÅFICO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function seleccionarIndicador(ind) {
        // Marcar seleccionado
        document.querySelectorAll('.indicador-card').forEach(c => c.classList.remove('seleccionado'));
        const card = document.getElementById(`ind_${ind.id}`);
        if (card) {
            card.classList.add('seleccionado');
            card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        indicadorActivo = ind;

        const centroId = document.getElementById('selCentro').value;
        if (!centroId) {
            showAlert('Seleccione un centro antes de generar el gr√°fico.', 'error');
            return;
        }

        const anioInicio = parseInt(document.getElementById('inputAnioInicio').value);
        const semInicio = parseInt(document.getElementById('selSemanaInicio').value);
        const anioFin = parseInt(document.getElementById('inputAnioFin').value);
        const semFin = parseInt(document.getElementById('selSemanaFin').value);

        const fechaDesde = getFechaISO(anioInicio, semInicio);
        const fechaHasta = getFechaISO(anioFin, semFin);

        showAlert('Cargando datos...', 'info');

        try {
            // Consultar registros del centro en el rango de fechas
            const q = query(
                collection(db, 'registros_semanales'),
                where('centro_id', '==', centroId)
            );
            const snap = await getDocs(q);
            let registros = [];
            snap.forEach(d => registros.push(d.data()));

            // Filtrar por rango de fechas
            registros = registros.filter(r =>
                compararFechasISO(r.fecha, fechaDesde) >= 0 &&
                compararFechasISO(r.fecha, fechaHasta) <= 0
            );

            // Ordenar por fecha
            registros.sort((a,b) => compararFechasISO(a.fecha, b.fecha));

            if (registros.length < 8) {
                showAlert(`Se necesitan al menos 8 semanas de datos. Se encontraron ${registros.length}.`, 'error');
                return;
            }

            // Calcular valores del indicador
            const valores = registros.map(r => {
                const num = r[ind.campo_numerador] || 0;
                const den = ind.campo_denominador ? (r[ind.campo_denominador] || 1) : 1;
                const mult = ind.multiplicador || 1;
                return parseFloat((num / den * mult).toFixed(6));
            });

            const periodos = registros.map(r => r.fecha);

            // Calcular PBC
            currentResults = calcPBC(valores, periodos);
            rangeStart = 1;
            rangeEnd = currentResults.length;

            // Mostrar gr√°fico
            document.getElementById('tituloGrafico').textContent = `${ind.nombre} ‚Äî ${centros.find(c=>c.id===centroId)?.nombre}`;
            document.getElementById('panelGrafico').classList.remove('hidden');
            document.getElementById('panelGrafico').scrollIntoView({ behavior: 'smooth' });

            actualizarRangeInfo();
            renderChart();
            showAlert(`Gr√°fico generado con ${registros.length} semanas.`, 'success');

        } catch(e) {
            showAlert('Error al cargar datos: ' + e.message, 'error');
        }
    }

    // ‚îÄ‚îÄ‚îÄ MOTOR PBC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function calcPBC(data, periodos) {
        const results = data.map((dp, i) => ({
            period: i + 1,
            date: periodos[i],
            dp,
            dpa: null, mr: null, mra: null,
            lcl: null, dla: null, dua: null, ucl: null, mrucl: null,
            signal: null, ruleApplied: null
        }));

        const dpa = data.slice(0,8).reduce((a,b) => a+b) / 8;
        const mrs = [];
        for (let i = 1; i < 8; i++) mrs.push(Math.abs(data[i] - data[i-1]));
        const mra = mrs.reduce((a,b) => a+b) / mrs.length;
        const factor = 3 / 1.128;
        const lcl = dpa - mra * factor;
        const ucl = dpa + mra * factor;
        const mrucl = mra * 3.27;
        const dla = (lcl + dpa) / 2;
        const dua = (dpa + ucl) / 2;

        for (let i = 0; i < 8; i++) {
            results[i].dpa = dpa; results[i].mra = mra;
            results[i].lcl = lcl; results[i].ucl = ucl;
            results[i].mrucl = mrucl; results[i].dla = dla;
            results[i].dua = dua; results[i].ruleApplied = 'L√≠nea Base';
            if (i > 0) results[i].mr = Math.abs(data[i] - data[i-1]);
        }

        for (let i = 8; i < data.length; i++) {
            const curr = data[i];
            const prev = data[i-1];
            const mr = Math.abs(curr - prev);
            results[i].mr = mr;

            const ref = results[i-1];
            let triggered = false;

            if ((curr > ref.ucl || curr < ref.lcl) && mr > ref.mrucl) results[i].signal = 1;

            if (i >= 7) {
                const last8 = data.slice(i-7, i+1);
                if (last8.every(dp => dp > ref.dpa) || last8.every(dp => dp < ref.dpa)) {
                    triggered = true;
                    const newDpa = last8.reduce((a,b) => a+b) / 8;
                    const newMrs = [Math.abs(data[i-7] - (i-8 >= 0 ? data[i-8] : data[i-7]))];
                    for (let j = 1; j < 8; j++) newMrs.push(Math.abs(last8[j] - last8[j-1]));
                    const newMra = newMrs.reduce((a,b) => a+b) / newMrs.length;
                    const newLcl = newDpa - newMra * factor;
                    const newUcl = newDpa + newMra * factor;
                    const newMrucl = newMra * 3.27;
                    for (let j = i-7; j <= i; j++) {
                        results[j].dpa = newDpa; results[j].mra = newMra;
                        results[j].lcl = newLcl; results[j].ucl = newUcl;
                        results[j].mrucl = newMrucl;
                        results[j].dla = (newLcl + newDpa) / 2;
                        results[j].dua = (newDpa + newUcl) / 2;
                        results[j].ruleApplied = 'Regla 2';
                    }
                }
            }

            if (!triggered && i >= 3) {
                const last4 = data.slice(i-3, i+1);
                const aboveDua = last4.filter(dp => dp > ref.dua).length;
                const belowDla = last4.filter(dp => dp < ref.dla).length;
                if (aboveDua >= 3 || belowDla >= 3) {
                    triggered = true;
                    const newDpa = last4.reduce((a,b) => a+b) / 4;
                    const newMrs = [Math.abs(data[i-3] - (i-4 >= 0 ? data[i-4] : data[i-3]))];
                    for (let j = 1; j < 4; j++) newMrs.push(Math.abs(last4[j] - last4[j-1]));
                    const newMra = newMrs.reduce((a,b) => a+b) / newMrs.length;
                    const newLcl = newDpa - newMra * factor;
                    const newUcl = newDpa + newMra * factor;
                    const newMrucl = newMra * 3.27;
                    for (let j = i-3; j <= i; j++) {
                        results[j].dpa = newDpa; results[j].mra = newMra;
                        results[j].lcl = newLcl; results[j].ucl = newUcl;
                        results[j].mrucl = newMrucl;
                        results[j].dla = (newLcl + newDpa) / 2;
                        results[j].dua = (newDpa + newUcl) / 2;
                        results[j].ruleApplied = 'Regla 3';
                    }
                }
            }

            if (!triggered) {
                results[i].dpa = ref.dpa; results[i].mra = ref.mra;
                results[i].lcl = ref.lcl; results[i].ucl = ref.ucl;
                results[i].mrucl = ref.mrucl; results[i].dla = ref.dla;
                results[i].dua = ref.dua; results[i].ruleApplied = ref.ruleApplied;
            }
        }

        return results;
    }

    // ‚îÄ‚îÄ‚îÄ RENDER CHART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderChart() {
        if (!currentResults) return;

        const filtered = currentResults.slice(rangeStart - 1, rangeEnd);
        const ctx = document.getElementById('pbcChart').getContext('2d');

        if (pbcChart) pbcChart.destroy();

        const labels = filtered.map(r => r.date);
        const dpData = filtered.map(r => r.dp);
        const dpaData = filtered.map(r => r.dpa);
        const uclData = filtered.map(r => r.ucl);
        const lclData = filtered.map(r => r.lcl);
        const pointColors = filtered.map(r => r.signal === 1 ? '#FF0000' : '#4169E1');

        pbcChart = new Chart(ctx, {
            type: 'line',
            plugins: [ChartDataLabels],
            data: {
                labels,
                datasets: [
                    {
                        label: indicadorActivo?.nombre || 'DP',
                        data: dpData,
                        borderColor: '#4169E1',
                        borderWidth: 2,
                        pointBackgroundColor: pointColors,
                        pointBorderColor: pointColors,
                        pointRadius: 3,
                        tension: 0
                    },
                    {
                        label: 'L√≠nea Central',
                        data: dpaData,
                        borderColor: '#228B22',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0
                    },
                    {
                        label: 'L√≠mite Superior',
                        data: uclData,
                        borderColor: '#DC143C',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0
                    },
                    {
                        label: 'L√≠mite Inferior',
                        data: lclData,
                        borderColor: '#DC143C',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: document.getElementById('tituloGrafico').textContent,
                        font: { size: 14, weight: 'bold' }
                    },
                    legend: { display: true, position: 'top' },
                    tooltip: { mode: 'index', intersect: false },
                    datalabels: {
                        display: ctx => ctx.datasetIndex === 0 && showLabels,
                        align: 'top',
                        offset: 6,
                        color: ctx => filtered[ctx.dataIndex]?.signal === 1 ? '#FF0000' : '#4169E1',
                        font: { size: 9, weight: 'bold' },
                        formatter: val => val.toFixed(2)
                    }
                },
                scales: {
                    x: {
                        ticks: { maxRotation: 45 },
                        grid: { display: false },
                        title: { display: true, text: 'Semanas ISO', font: { weight: 'bold' } }
                    },
                    y: {
                        beginAtZero: yAxisFromZero,
                        min: yAxisFromZero ? 0 : undefined,
                        title: { display: true, text: indicadorActivo?.nombre || 'Valor', font: { weight: 'bold' } }
                    }
                }
            }
        });
    }

    // ‚îÄ‚îÄ‚îÄ CONTROLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.toggleYAxis = function() {
        yAxisFromZero = !yAxisFromZero;
        renderChart();
    }

    window.toggleLabels = function() {
        showLabels = !showLabels;
        renderChart();
    }

    window.mostrarTodo = function() {
        if (!currentResults) return;
        rangeStart = 1;
        rangeEnd = currentResults.length;
        actualizarRangeInfo();
        renderChart();
    }

    window.mostrarUltimos24 = function() {
        if (!currentResults) return;
        rangeEnd = currentResults.length;
        rangeStart = Math.max(1, rangeEnd - 23);
        actualizarRangeInfo();
        renderChart();
    }

    function actualizarRangeInfo() {
        if (!currentResults) return;
        document.getElementById('rangeInfo').textContent =
            `Visualizando semanas ${rangeStart} a ${rangeEnd} de ${currentResults.length} totales`;
    }

    window.downloadChart = function() {
        if (!pbcChart) return;
        const link = document.createElement('a');
        link.download = `${indicadorActivo?.nombre || 'grafico'}.png`;
        link.href = pbcChart.toBase64Image('image/png', 1.0);
        link.click();
    }

    window.copyChart = async function() {
        if (!pbcChart) return;
        pbcChart.canvas.toBlob(async blob => {
            try {
                await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
                showAlert('Gr√°fico copiado al portapapeles.', 'success');
            } catch(e) {
                showAlert('No se pudo copiar. Use clic derecho en el gr√°fico.', 'error');
            }
        });
    }

    // ‚îÄ‚îÄ‚îÄ CERRAR SESI√ìN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.cerrarSesion = async function() {
        await signOut(auth);
        sessionStorage.clear();
        window.location.href = 'login.html';
    }

    // ‚îÄ‚îÄ‚îÄ INICIALIZACI√ìN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    onAuthStateChanged(auth, async user => {
        if (!user) {
            window.location.href = 'login.html';
            return;
        }

        const usuario = JSON.parse(sessionStorage.getItem('usuario') || '{}');
        if (usuario.nombre) {
            document.getElementById('headerSubtitle').textContent = `${usuario.nombre} ‚Äî Semanas ISO`;
        }

        // Verificar si viene con indicador preseleccionado desde index.html
        const params = new URLSearchParams(window.location.search);
        const indId = params.get('indicador');

        poblarSemanas('selSemanaInicio');
        poblarSemanas('selSemanaFin');

        // Fechas por defecto
        const now = new Date();
        document.getElementById('inputAnioFin').value = now.getFullYear();
        document.getElementById('inputAnioInicio').value = now.getFullYear() - 1;

        // Semana actual como fin
        const startOfYear = new Date(now.getFullYear(), 0, 1);
        const weekNum = Math.ceil(((now - startOfYear) / 86400000 + startOfYear.getDay() + 1) / 7);
        document.getElementById('selSemanaFin').value = String(Math.max(1, weekNum - 1)).padStart(2,'0');
        document.getElementById('selSemanaInicio').value = '01';

        await cargarCentros();
        await cargarIndicadores();

        // Si viene con indicador desde buscador del home
        if (indId) {
            const ind = indicadores.find(i => i.id === indId);
            if (ind) seleccionarIndicador(ind);
        }
    });
</script>
</body>
</html>