<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indicadores Semanales</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f4f8;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: white;
            border: 2px solid black;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 { font-size: 2em; margin-bottom: 5px; }
        .header p { color: #555; }
        .header-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .nav-btn {
            background: white;
            border: 2px solid black;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95em;
        }
        .nav-btn:hover { background: #f0f0f0; }
        .nav-btn.rojo { border-color: #dc3545; color: #dc3545; }
        .nav-btn.rojo:hover { background: #f8d7da; }
        .card {
            background: white;
            border: 2px solid black;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        .card h2 {
            font-size: 1.3em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .form-col { flex: 1; min-width: 180px; }
        .form-col label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
        }
        select, input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
            font-family: inherit;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #1a73e8;
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background: #1a73e8; color: white; }
        .btn-primary:hover { background: #1558b0; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .alert {
            padding: 12px 18px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-weight: 500;
            display: none;
        }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .hidden { display: none; }
        .grupos-nav {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .grupo-btn {
            padding: 8px 16px;
            border: 2px solid #1a73e8;
            border-radius: 20px;
            background: white;
            color: #1a73e8;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        .grupo-btn.active {
            background: #1a73e8;
            color: white;
        }
        .indicadores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .indicador-card {
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .indicador-card:hover {
            border-color: #1a73e8;
            background: #e8f0fe;
        }
        .indicador-card.selected {
            border-color: #1a73e8;
            background: #e8f0fe;
        }
        .indicador-card h3 { font-size: 1em; margin-bottom: 5px; }
        .indicador-card p { font-size: 0.85em; color: #666; }
        .chart-container {
            position: relative;
            height: 500px;
            margin-bottom: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
        }
        .chart-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: bold;
            background: #e8f0fe;
            color: #1a73e8;
            margin-left: 8px;
        }
        @media (max-width: 600px) {
            .form-row { flex-direction: column; }
            .chart-container { height: 350px; }
        }
        .heatmap-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .heatmap-table th {
            padding: 8px 10px;
            background: #f8f9fa;
            font-size: 0.85em;
            text-align: center;
            border: 1px solid #ddd;
            white-space: nowrap;
        }
        .heatmap-table td {
            padding: 8px 10px;
            border: 1px solid #ddd;
            text-align: center;
            font-size: 0.9em;
        }
        .heatmap-table td.servicio {
            text-align: left;
            font-weight: 600;
            background: #f8f9fa;
            white-space: nowrap;
        }
        .celda-verde { background: #d4edda; color: #155724; }
        .celda-amarilla { background: #fff3cd; color: #856404; font-weight: bold; }
        .celda-roja { background: #f8d7da; color: #721c24; font-weight: bold; }
        .celda-vacia { background: #f8f9fa; color: #ccc; }
    </style>
</head>
<body>
<div class="container">

    <!-- HEADER -->
    <div class="header">
        <h1>üìÖ Indicadores Semanales</h1>
        <p id="headerSubtitle">Gr√°ficos por semana ISO</p>
        <div class="header-actions">
            <button class="nav-btn" onclick="window.location.href='index.html'">‚Üê Inicio</button>
            <button class="nav-btn rojo" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
        </div>
    </div>

    <!-- ALERTA -->
    <div id="alertBox" class="alert"></div>

    <!-- FILTROS PBC -->
    <div class="card" id="filtrosPBC">
        <h2>Filtros</h2>
        <div class="form-row">
            <div class="form-col">
                <label>Red</label>
                <select id="selRed" onchange="filtrarCentrosPorRed()">
                    <option value="">-- Todas las redes --</option>
                </select>
            </div>
            <div class="form-col">
                <label>Centro</label>
                <select id="selCentro">
                    <option value="">-- Todos los centros --</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-col">
                <label>Desde semana</label>
                <select id="selSemanaDesde"></select>
            </div>
            <div class="form-col">
                <label>del A√±o</label>
                <input type="number" id="inputAnioDesde" min="2000" max="2100" value="2025">
            </div>
        </div>
        <div class="form-row">
            <div class="form-col">
                <label>Hasta semana</label>
                <select id="selSemanaHasta"></select>
            </div>
            <div class="form-col">
                <label>del A√±o</label>
                <input type="number" id="inputAnioHasta" min="2000" max="2100" value="2025">
            </div>
        </div>
    </div>



    <!-- NAVEGACI√ìN POR GRUPOS -->
    <div class="card">
        <h2>Indicadores</h2>
        <div class="grupos-nav" id="gruposNav"></div>
        <div class="indicadores-grid" id="indicadoresGrid"></div>
    </div>

    <!-- CLUSTERING NIVEL 1: VISTA POR RED -->
    <div class="card hidden" id="cardNivel1">
        <h2 id="tituloNivel1">Vista por Red</h2>
        <div style="margin-bottom:15px;">
            <label style="font-weight:600; margin-right:10px;">Tipo de Atenci√≥n:</label>
            <select id="selTipoAtencionN1" onchange="recargarNivel1()" style="width:auto; padding:6px 10px;">
                <option value="">-- Todos --</option>
                <option value="hospitalaria">Hospitalizada/o</option>
                <option value="urgencias">Urgencias</option>
                <option value="ambulatoria">Ambulatoria</option>
            </select>
        </div>
        <div style="margin-bottom:10px; color:#555; font-size:0.9em;" id="infoNivel1"></div>
        <div style="overflow-x:auto;">
            <table class="heatmap-table" id="tablaNivel1">
                <thead><tr id="headNivel1"></tr></thead>
                <tbody id="bodyNivel1"></tbody>
            </table>
        </div>
        <div style="margin-top:15px; display:flex; gap:20px; font-size:0.85em;">
            <span>üü¢ Sin eventos</span>
            <span>üü° Alerta</span>
            <span>üî¥ Clustering</span>
        </div>
        <div style="margin-top:20px;">
            <h3 style="font-size:1em; margin-bottom:10px;">Incidentes diarios ‚Äî √∫ltimos 365 d√≠as (Red)</h3>
            <div style="position:relative; height:250px;">
                <canvas id="chartNivel1"></canvas>
            </div>
        </div>
    </div>

    <!-- CLUSTERING NIVEL 2: VISTA POR CENTRO -->
    <div class="card hidden" id="cardNivel2">
        <div style="margin-bottom:15px;">
            <button class="nav-btn" onclick="volverNivel1()">‚Üê Volver a Red</button>
        </div>
        <h2 id="tituloNivel2">Vista por Centro</h2>
        <div style="margin-bottom:15px;">
            <label style="font-weight:600; margin-right:10px;">Tipo de Atenci√≥n:</label>
            <select id="selTipoAtencionN2" onchange="recargarNivel2()" style="width:auto; padding:6px 10px;">
                <option value="">-- Todos --</option>
                <option value="hospitalaria">Hospitalizada/o</option>
                <option value="urgencias">Urgencias</option>
                <option value="ambulatoria">Ambulatoria</option>
            </select>
        </div>
        <div style="margin-bottom:10px; color:#555; font-size:0.9em;" id="infoNivel2"></div>
        <div style="overflow-x:auto;">
            <table class="heatmap-table" id="tablaNivel2">
                <thead><tr id="headNivel2"></tr></thead>
                <tbody id="bodyNivel2"></tbody>
            </table>
        </div>
        <div style="margin-top:15px; display:flex; gap:20px; font-size:0.85em;">
            <span>üü¢ Sin eventos</span>
            <span>üü° Alerta</span>
            <span>üî¥ Clustering</span>
        </div>
        <div style="margin-top:20px;">
            <h3 style="font-size:1em; margin-bottom:10px;">Incidentes diarios ‚Äî √∫ltimos 365 d√≠as (Centro)</h3>
            <div style="position:relative; height:250px;">
                <canvas id="chartNivel2"></canvas>
            </div>
        </div>
    </div>

    <!-- CLUSTERING NIVEL 3: VISTA POR SERVICIO -->
    <div class="card hidden" id="cardNivel3">
        <div style="margin-bottom:15px;">
            <button class="nav-btn" onclick="volverNivel2()">‚Üê Volver a Centro</button>
        </div>
        <h2 id="tituloNivel3">Vista por Servicio</h2>
        <div style="margin-bottom:10px; color:#555; font-size:0.9em;" id="infoNivel3"></div>
        <div style="overflow-x:auto;">
            <table class="heatmap-table" id="tablaNivel3">
                <thead><tr id="headNivel3"></tr></thead>
                <tbody id="bodyNivel3"></tbody>
            </table>
        </div>
        <div style="margin-top:15px; display:flex; gap:20px; font-size:0.85em;">
            <span>üü¢ Sin eventos</span>
            <span>üü° Alerta</span>
            <span>üî¥ Clustering</span>
        </div>
    </div>

    <!-- GR√ÅFICO PBC -->
    <div class="card hidden" id="cardGrafico">
        <h2 id="tituloGrafico">Gr√°fico PBC</h2>
        <div class="chart-actions">
            <button class="btn btn-primary" onclick="generarGrafico()">‚Ü∫ Actualizar</button>
            <button class="btn btn-secondary" onclick="descargarGrafico()">Descargar PNG</button>
        </div>
        <div class="chart-container">
            <canvas id="pbcChart"></canvas>
        </div>
        <div id="infoSerie" style="color:#555; font-size:0.9em; margin-top:10px;"></div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBgxwwm7Q0kf0DgkjZip0rIvobRnXVJUXw",
        authDomain: "indicadores-gestion-clinica.firebaseapp.com",
        projectId: "indicadores-gestion-clinica",
        storageBucket: "indicadores-gestion-clinica.firebasestorage.app",
        messagingSenderId: "1221554815",
        appId: "1:1221554815:web:f304f787f2a953ce59454a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let centros = [];
    let indicadores = [];
    let redes = [];
    let indicadorSeleccionado = null;
    let pbcChart = null;
    let grupoActivo = null;

    // ‚îÄ‚îÄ‚îÄ UTILIDADES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showAlert(msg, type = 'info') {
        const box = document.getElementById('alertBox');
        box.className = `alert alert-${type}`;
        box.textContent = msg;
        box.style.display = 'block';
        setTimeout(() => box.style.display = 'none', 4000);
    }

    function poblarSemanas(selectId, valorDefault) {
        const sel = document.getElementById(selectId);
        sel.innerHTML = '';
        for (let i = 1; i <= 53; i++) {
            const opt = document.createElement('option');
            opt.value = String(i).padStart(2,'0');
            opt.textContent = `Semana ${i}`;
            sel.appendChild(opt);
        }
        sel.value = String(valorDefault).padStart(2,'0');
    }

    function getSemanaActual() {
        const now = new Date();
        const jan4 = new Date(now.getFullYear(), 0, 4);
        const startOfWeek1 = new Date(jan4);
        startOfWeek1.setDate(jan4.getDate() - ((jan4.getDay() + 6) % 7));
        const diff = now - startOfWeek1;
        if (diff < 0) return 53;
        return Math.floor(diff / (7 * 86400000)) + 1;
    }

    function getFechaDesde() {
        const sem = document.getElementById('selSemanaDesde').value;
        const anio = document.getElementById('inputAnioDesde').value;
        return `${anio}-W${sem}`;
    }

    function getFechaHasta() {
        const sem = document.getElementById('selSemanaHasta').value;
        const anio = document.getElementById('inputAnioHasta').value;
        return `${anio}-W${sem}`;
    }

    function fechaAISOWeek(fechaStr) {
        const d = new Date(fechaStr + 'T12:00:00');
        const jan4 = new Date(d.getFullYear(), 0, 4);
        const startOfWeek1 = new Date(jan4);
        startOfWeek1.setDate(jan4.getDate() - ((jan4.getDay() + 6) % 7));
        const diff = d - startOfWeek1;
        if (diff < 0) {
            const jan4prev = new Date(d.getFullYear() - 1, 0, 4);
            const startOfWeek1prev = new Date(jan4prev);
            startOfWeek1prev.setDate(jan4prev.getDate() - ((jan4prev.getDay() + 6) % 7));
            const semana = Math.floor((d - startOfWeek1prev) / (7 * 86400000)) + 1;
            return `${d.getFullYear()-1}-W${String(semana).padStart(2,'0')}`;
        }
        const semana = Math.floor(diff / (7 * 86400000)) + 1;
        return `${d.getFullYear()}-W${String(semana).padStart(2,'0')}`;
    }

    function semanasEnAnio(anio) {
        const d = new Date(anio, 11, 28);
        const startOfYear = new Date(anio, 0, 1);
        return Math.ceil(((d - startOfYear) / 86400000 + startOfYear.getDay() + 1) / 7);
    }

    // ‚îÄ‚îÄ‚îÄ CARGA INICIAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function cargarRedes() {
        const snap = await getDocs(collection(db, 'redes'));
        redes = [];
        snap.forEach(d => redes.push({ id: d.id, ...d.data() }));
        redes.sort((a,b) => a.nombre.localeCompare(b.nombre));

        const sel = document.getElementById('selRed');
        redes.filter(r => r.activo !== false).forEach(r => {
            const opt = document.createElement('option');
            opt.value = r.id;
            opt.textContent = r.nombre;
            sel.appendChild(opt);
        });
    }

    async function cargarCentros() {
        const snap = await getDocs(collection(db, 'centros'));
        centros = [];
        snap.forEach(d => centros.push({ id: d.id, ...d.data() }));
        centros.sort((a,b) => a.nombre.localeCompare(b.nombre));
        poblarSelCentros('');
    }

    function poblarSelCentros(redId) {
        const sel = document.getElementById('selCentro');
        sel.innerHTML = '<option value="">-- Todos los centros --</option>';
        const filtrados = redId
            ? centros.filter(c => c.activo !== false && c.red_id === redId)
            : centros.filter(c => c.activo !== false);
        filtrados.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.nombre;
            sel.appendChild(opt);
        });
    }

    window.filtrarCentrosPorRed = function() {
        const redId = document.getElementById('selRed').value;
        poblarSelCentros(redId);
    }

    async function cargarIndicadores() {
        const snap = await getDocs(collection(db, 'indicadores_semanales'));
        indicadores = [];
        snap.forEach(d => indicadores.push({ id: d.id, ...d.data() }));
        indicadores.sort((a,b) => a.nombre.localeCompare(b.nombre));

        renderGrupos();

        const params = new URLSearchParams(window.location.search);
        const indId = params.get('indicador');
        if (indId) {
            const ind = indicadores.find(i => i.id === indId);
            if (ind) seleccionarIndicador(ind);
        }
    }

    // ‚îÄ‚îÄ‚îÄ NAVEGACI√ìN POR GRUPOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderGrupos() {
        const grupos = [...new Set(indicadores.map(i => i.grupo))].sort();
        const nav = document.getElementById('gruposNav');
        nav.innerHTML = '';

        const btnTodos = document.createElement('button');
        btnTodos.className = 'grupo-btn active';
        btnTodos.textContent = 'Todos';
        btnTodos.onclick = () => filtrarPorGrupo(null, btnTodos);
        nav.appendChild(btnTodos);

        grupos.forEach(grupo => {
            const btn = document.createElement('button');
            btn.className = 'grupo-btn';
            btn.textContent = grupo;
            btn.onclick = () => filtrarPorGrupo(grupo, btn);
            nav.appendChild(btn);
        });

        renderIndicadores(indicadores);
    }

    function filtrarPorGrupo(grupo, btnClicked) {
        grupoActivo = grupo;
        document.querySelectorAll('.grupo-btn').forEach(b => b.classList.remove('active'));
        btnClicked.classList.add('active');
        const filtrados = grupo ? indicadores.filter(i => i.grupo === grupo) : indicadores;
        renderIndicadores(filtrados);
    }

    function renderIndicadores(lista) {
        const grid = document.getElementById('indicadoresGrid');
        grid.innerHTML = '';

        const subgrupos = [...new Set(lista.map(i => i.subgrupo || 'General'))].sort();

        subgrupos.forEach(subgrupo => {
            const inds = lista.filter(i => (i.subgrupo || 'General') === subgrupo);

            const subgrupoDiv = document.createElement('div');
            subgrupoDiv.style.gridColumn = '1/-1';
            subgrupoDiv.innerHTML = `<h3 style="font-size:1em; color:#555; margin-bottom:10px; padding-bottom:5px; border-bottom:1px solid #eee;">${subgrupo}</h3>`;
            grid.appendChild(subgrupoDiv);

            inds.forEach(ind => {
                const card = document.createElement('div');
                card.className = 'indicador-card';
                card.id = `ind_${ind.id}`;

                const tipo = ind.tipo_grafico === 'clustering' ? 'Clustering' :
                    (ind.campo_denominador && ind.campo_denominador !== '1' && ind.campo_denominador !== '' ?
                        (ind.multiplicador > 1 ? 'Tasa' : '√çndice') : 'Volumen');

                card.innerHTML = `
                    <h3>${ind.nombre}</h3>
                    <p>${ind.grupo}${ind.subgrupo ? ' ‚Ä∫ ' + ind.subgrupo : ''}</p>
                    <span class="badge">${tipo}</span>
                `;
                card.onclick = () => seleccionarIndicador(ind);

                if (indicadorSeleccionado?.id === ind.id) card.classList.add('selected');
                grid.appendChild(card);
            });
        });
    }

    // ‚îÄ‚îÄ‚îÄ SELECCIONAR INDICADOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function seleccionarIndicador(ind) {
        indicadorSeleccionado = ind;
        document.querySelectorAll('.indicador-card').forEach(c => c.classList.remove('selected'));
        const card = document.getElementById(`ind_${ind.id}`);
        if (card) card.classList.add('selected');

        if (ind.tipo_grafico === 'clustering') {
            document.getElementById('filtrosPBC').classList.add('hidden');
            
            document.getElementById('cardGrafico').classList.add('hidden');
            document.getElementById('cardNivel1').classList.add('hidden');
            document.getElementById('cardNivel2').classList.add('hidden');
            document.getElementById('cardNivel3').classList.add('hidden');
            
            cargarDatosClustering();
        } else {
            
            document.getElementById('filtrosPBC').classList.remove('hidden');
            document.getElementById('cardNivel1').classList.add('hidden');
            document.getElementById('cardNivel2').classList.add('hidden');
            document.getElementById('cardNivel3').classList.add('hidden');
            generarGrafico();
        }
    }

    // ‚îÄ‚îÄ‚îÄ GENERAR GR√ÅFICO PBC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.generarGrafico = async function() {
        if (!indicadorSeleccionado) {
            showAlert('Seleccione un indicador.', 'info');
            return;
        }

        const centroId = document.getElementById('selCentro').value;
        const fechaDesde = getFechaDesde();
        const fechaHasta = getFechaHasta();

        if (fechaDesde > fechaHasta) {
            showAlert('La fecha desde no puede ser mayor que la fecha hasta.', 'error');
            return;
        }

        let q;
        if (centroId) {
            q = query(collection(db, 'registros_semanales'), where('centro_id', '==', centroId));
        } else {
            q = query(collection(db, 'registros_semanales'));
        }

        const snap = await getDocs(q);
        let registros = [];
        snap.forEach(d => registros.push({ id: d.id, ...d.data() }));

        registros = registros.filter(r => r.fecha >= fechaDesde && r.fecha <= fechaHasta);
        registros.sort((a,b) => a.fecha.localeCompare(b.fecha));

        if (registros.length === 0) {
            showAlert('No hay datos para el per√≠odo y centro seleccionados.', 'info');
            return;
        }

        const ind = indicadorSeleccionado;
        const denominadorCampo = ind.campo_denominador;
        const multiplicador = parseFloat(ind.multiplicador) || 1;

        const labels = [];
        const valores = [];

        registros.forEach(r => {
            const num = parseFloat(r[ind.campo_numerador]);
            let den;
            if (!denominadorCampo || denominadorCampo === '' || denominadorCampo === '1') {
                den = 1;
            } else {
                den = parseFloat(r[denominadorCampo]);
            }
            if (isNaN(num) || isNaN(den) || den === 0) return;
            const valor = (num / den) * multiplicador;
            labels.push(r.fecha);
            valores.push(valor);
        });

        if (valores.length < 8) {
            showAlert(`Se necesitan al menos 8 puntos de datos. Solo hay ${valores.length} disponibles.`, 'error');
            return;
        }

        const resultados = calcularPBC(valores, labels);

        document.getElementById('cardGrafico').classList.remove('hidden');
        document.getElementById('tituloGrafico').textContent = ind.nombre;
        document.getElementById('infoSerie').textContent =
            `${valores.length} semanas | Centro: ${centroId ? centros.find(c=>c.id===centroId)?.nombre : 'Todos'} | ${fechaDesde} a ${fechaHasta}`;

        renderPBC(resultados, labels, ind.nombre);
        document.getElementById('cardGrafico').scrollIntoView({ behavior: 'smooth' });
    }

    // ‚îÄ‚îÄ‚îÄ MOTOR PBC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function calcularPBC(data, labels) {
        const factor = 3 / 1.128;
        const results = data.map((dp, i) => ({
            period: i + 1, date: labels[i], dp,
            dpa: null, mr: null, mra: null,
            lcl: null, dla: null, dua: null, ucl: null, mrucl: null,
            signal: null, ruleApplied: null
        }));

        const dpa = data.slice(0,8).reduce((a,b) => a+b) / 8;
        const mrs = [];
        for (let i = 1; i < 8; i++) mrs.push(Math.abs(data[i] - data[i-1]));
        const mra = mrs.reduce((a,b) => a+b) / mrs.length;
        const lcl = dpa - mra * factor;
        const ucl = dpa + mra * factor;
        const mrucl = mra * 3.27;
        const dla = (lcl + dpa) / 2;
        const dua = (dpa + ucl) / 2;

        for (let i = 0; i < 8; i++) {
            results[i].dpa = dpa; results[i].mra = mra;
            results[i].lcl = lcl; results[i].ucl = ucl;
            results[i].mrucl = mrucl; results[i].dla = dla;
            results[i].dua = dua; results[i].ruleApplied = 'base';
            if (i > 0) results[i].mr = Math.abs(data[i] - data[i-1]);
        }

        for (let i = 8; i < data.length; i++) {
            const curr = data[i];
            const prev = results[i-1];
            const mr = Math.abs(curr - data[i-1]);
            results[i].mr = mr;
            let ruleTriggered = false;

            if ((curr > prev.ucl || curr < prev.lcl) && mr > prev.mrucl) results[i].signal = 1;

            if (i >= 7) {
                const last8 = data.slice(i-7, i+1);
                if (last8.every(dp => dp > prev.dpa) || last8.every(dp => dp < prev.dpa)) {
                    ruleTriggered = true;
                    const newDPA = last8.reduce((a,b) => a+b) / 8;
                    const newMRs = [Math.abs(data[i-7] - (i-8 >= 0 ? data[i-8] : data[i-7]))];
                    for (let j = 1; j < 8; j++) newMRs.push(Math.abs(last8[j] - last8[j-1]));
                    const newMRA = newMRs.reduce((a,b) => a+b) / newMRs.length;
                    const newLCL = newDPA - newMRA * factor;
                    const newUCL = newDPA + newMRA * factor;
                    for (let j = i-7; j <= i; j++) {
                        results[j].dpa = newDPA; results[j].mra = newMRA;
                        results[j].lcl = newLCL; results[j].ucl = newUCL;
                        results[j].mrucl = newMRA * 3.27;
                        results[j].dla = (newLCL + newDPA) / 2;
                        results[j].dua = (newDPA + newUCL) / 2;
                        results[j].ruleApplied = 'regla2';
                    }
                }
            }

            if (!ruleTriggered && i >= 3) {
                const last4 = data.slice(i-3, i+1);
                if (last4.filter(dp => dp > prev.dua).length >= 3 ||
                    last4.filter(dp => dp < prev.dla).length >= 3) {
                    ruleTriggered = true;
                    const newDPA = last4.reduce((a,b) => a+b) / 4;
                    const newMRs = [Math.abs(data[i-3] - (i-4 >= 0 ? data[i-4] : data[i-3]))];
                    for (let j = 1; j < 4; j++) newMRs.push(Math.abs(last4[j] - last4[j-1]));
                    const newMRA = newMRs.reduce((a,b) => a+b) / newMRs.length;
                    const newLCL = newDPA - newMRA * factor;
                    const newUCL = newDPA + newMRA * factor;
                    for (let j = i-3; j <= i; j++) {
                        results[j].dpa = newDPA; results[j].mra = newMRA;
                        results[j].lcl = newLCL; results[j].ucl = newUCL;
                        results[j].mrucl = newMRA * 3.27;
                        results[j].dla = (newLCL + newDPA) / 2;
                        results[j].dua = (newDPA + newUCL) / 2;
                        results[j].ruleApplied = 'regla3';
                    }
                }
            }

            if (!ruleTriggered) {
                results[i].dpa = prev.dpa; results[i].mra = prev.mra;
                results[i].lcl = prev.lcl; results[i].ucl = prev.ucl;
                results[i].mrucl = prev.mrucl; results[i].dla = prev.dla;
                results[i].dua = prev.dua; results[i].ruleApplied = prev.ruleApplied;
            }
        }

        return results;
    }

    // ‚îÄ‚îÄ‚îÄ RENDERIZAR GR√ÅFICO PBC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderPBC(results, labels, titulo) {
        if (pbcChart) pbcChart.destroy();

        const ctx = document.getElementById('pbcChart').getContext('2d');
        const dpColors = results.map(r => r.signal === 1 ? '#FF0000' : '#4169E1');

        pbcChart = new Chart(ctx, {
            type: 'line',
            plugins: [ChartDataLabels],
            data: {
                labels: results.map(r => r.date),
                datasets: [
                    {
                        label: titulo,
                        data: results.map(r => r.dp),
                        borderColor: '#4169E1',
                        borderWidth: 2,
                        pointBackgroundColor: dpColors,
                        pointBorderColor: dpColors,
                        pointRadius: 4,
                        tension: 0
                    },
                    {
                        label: 'L√≠nea Central',
                        data: results.map(r => r.dpa),
                        borderColor: '#228B22',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0
                    },
                    {
                        label: 'LCS',
                        data: results.map(r => r.ucl),
                        borderColor: '#DC143C',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0
                    },
                    {
                        label: 'LCI',
                        data: results.map(r => r.lcl),
                        borderColor: '#DC143C',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: titulo,
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: { display: true, position: 'top' },
                    datalabels: {
                        display: (ctx) => ctx.datasetIndex === 0,
                        align: 'top',
                        offset: 6,
                        color: (ctx) => results[ctx.dataIndex].signal === 1 ? '#FF0000' : '#4169E1',
                        font: { size: 9, weight: 'bold' },
                        formatter: (value) => value.toFixed(2)
                    }
                },
                scales: {
                    x: { ticks: { maxRotation: 45 }, grid: { display: false } },
                    y: { beginAtZero: false }
                }
            }
        });
    }

    // ‚îÄ‚îÄ‚îÄ CLUSTERING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let incidentesCache = [];
    let serviciosCache = [];
    let centroActivoClust = null;
    let chartN1 = null;
    let chartN2 = null;

    async function cargarDatosClustering() {
        const ind = indicadorSeleccionado;
        const tipoAtencion = document.getElementById('selTipoAtencionN1').value;
        

        const snap = await getDocs(query(collection(db, 'incidentes'),
            where('indicador_id', '==', ind.id)
        ));
        incidentesCache = [];
        snap.forEach(d => incidentesCache.push({ id: d.id, ...d.data() }));

        if (tipoAtencion) {
            incidentesCache = incidentesCache.filter(i => i.tipo_atencion === tipoAtencion);
        }

        const snapSrv = await getDocs(collection(db, 'unidad_servicio'));
        serviciosCache = [];
        snapSrv.forEach(d => serviciosCache.push({ id: d.id, ...d.data() }));

        const redIdPBC = document.getElementById('selRed').value;
        const centroIdPBC = document.getElementById('selCentro').value;

        let centrosVista = centros.filter(c => c.activo !== false);
        if (centroIdPBC) {
            centrosVista = centrosVista.filter(c => c.id === centroIdPBC);
        } else if (redIdPBC) {
            centrosVista = centrosVista.filter(c => c.red_id === redIdPBC);
        }

        mostrarNivel1(centrosVista, ind);
    }

    function mostrarNivel1(centrosVista, ind) {
        const semanas = ultimasNSemanas(8);

        const head = document.getElementById('headNivel1');
        head.innerHTML = `<th>Centro</th>${semanas.map(s => `<th>${s}</th>`).join('')}`;

        const tbody = document.getElementById('bodyNivel1');
        tbody.innerHTML = '';

        centrosVista.forEach(centro => {
            const incCentro = incidentesCache.filter(i => i.centro_id === centro.id);
            const tr = document.createElement('tr');
            let celdas = `<td class="servicio" style="cursor:pointer; color:#1a73e8;" onclick="mostrarNivel2('${centro.id}')">${centro.nombre}</td>`;

            semanas.forEach(sem => {
                const count = incCentro.filter(i => fechaAISOWeek(i.fecha) === sem).length;
                celdas += `<td class="${colorCelda(count, ind)}">${count === 0 ? '‚Äî' : count}</td>`;
            });

            tr.innerHTML = celdas;
            tbody.appendChild(tr);
        });

        document.getElementById('tituloNivel1').textContent = ind.nombre;
        document.getElementById('infoNivel1').textContent = `√öltimas 8 semanas | ${centrosVista.length} centro(s)`;
        document.getElementById('cardNivel1').classList.remove('hidden');
        document.getElementById('cardNivel2').classList.add('hidden');
        document.getElementById('cardNivel3').classList.add('hidden');

        const incRed = incidentesCache.filter(i => centrosVista.some(c => c.id === i.centro_id));
        renderGrafico365(incRed, 'chartNivel1', chartN1, (chart) => chartN1 = chart);

        document.getElementById('cardNivel1').scrollIntoView({ behavior: 'smooth' });
    }

    window.mostrarNivel2 = async function(centroId) {
        centroActivoClust = centroId;
        const ind = indicadorSeleccionado;
        const semanas = ultimasNSemanas(8);
        const centro = centros.find(c => c.id === centroId);

        const srvCentro = serviciosCache.filter(s => s.centro_id === centroId && s.activo !== false);
        srvCentro.sort((a,b) => a.unidad.localeCompare(b.unidad));

        const tipoAtencionN2 = document.getElementById('selTipoAtencionN2').value;
        let incCentro = incidentesCache.filter(i => i.centro_id === centroId);
        if (tipoAtencionN2) incCentro = incCentro.filter(i => i.tipo_atencion === tipoAtencionN2);

        const head = document.getElementById('headNivel2');
        head.innerHTML = `<th>Servicio</th>${semanas.map(s => `<th>${s}</th>`).join('')}`;

        const tbody = document.getElementById('bodyNivel2');
        tbody.innerHTML = '';

        srvCentro.forEach(srv => {
            const nombreSrv = `${srv.unidad}${srv.edificio ? ' ‚Äî ' + srv.edificio : ''}${srv.piso ? ', Piso ' + srv.piso : ''}`;
            const incSrv = incCentro.filter(i => i.unidad_servicio_id === srv.id);
            const tr = document.createElement('tr');
            let celdas = `<td class="servicio" style="cursor:pointer; color:#1a73e8;" onclick="mostrarNivel3('${srv.id}')">${nombreSrv}</td>`;

            semanas.forEach(sem => {
                const count = incSrv.filter(i => fechaAISOWeek(i.fecha) === sem).length;
                celdas += `<td class="${colorCelda(count, ind)}">${count === 0 ? '‚Äî' : count}</td>`;
            });

            tr.innerHTML = celdas;
            tbody.appendChild(tr);
        });

        document.getElementById('tituloNivel2').textContent = `${ind.nombre} ‚Äî ${centro?.nombre}`;
        document.getElementById('infoNivel2').textContent = `√öltimas 8 semanas | ${srvCentro.length} servicio(s)`;
        document.getElementById('cardNivel2').classList.remove('hidden');
        document.getElementById('cardNivel3').classList.add('hidden');

        renderGrafico365(incCentro, 'chartNivel2', chartN2, (chart) => chartN2 = chart);

        document.getElementById('cardNivel2').scrollIntoView({ behavior: 'smooth' });
    }

    window.mostrarNivel3 = function(servicioId) {
        const ind = indicadorSeleccionado;
        const srv = serviciosCache.find(s => s.id === servicioId);
        const nombreSrv = `${srv.unidad}${srv.edificio ? ' ‚Äî ' + srv.edificio : ''}${srv.piso ? ', Piso ' + srv.piso : ''}`;

        const semanas = ultimasNSemanas(4);
        const incSrv = incidentesCache.filter(i => i.unidad_servicio_id === servicioId);

        const head = document.getElementById('headNivel3');
        head.innerHTML = `<th>Semana</th><th>Lun</th><th>Mar</th><th>Mi√©</th><th>Jue</th><th>Vie</th><th>S√°b</th><th>Dom</th>`;

        const tbody = document.getElementById('bodyNivel3');
        tbody.innerHTML = '';

        semanas.forEach(sem => {
            const diasSemana = obtenerDiasDeSemana(sem);
            const tr = document.createElement('tr');
            let celdas = `<td class="servicio">${sem}</td>`;

            diasSemana.forEach(dia => {
                const count = incSrv.filter(i => i.fecha === dia).length;
                celdas += `<td class="${colorCelda(count, ind)}" title="${dia}">${count === 0 ? '‚Äî' : count}</td>`;
            });

            tr.innerHTML = celdas;
            tbody.appendChild(tr);
        });

        document.getElementById('tituloNivel3').textContent = `${ind.nombre} ‚Äî ${nombreSrv}`;
        document.getElementById('infoNivel3').textContent = `√öltimas 4 semanas | detalle diario`;
        document.getElementById('cardNivel3').classList.remove('hidden');
        document.getElementById('cardNivel3').scrollIntoView({ behavior: 'smooth' });
    }

    function renderGrafico365(incidentes, canvasId, chartRef, setChart) {
        const hoy = new Date();
        const fechas = [];
        const counts = {};
        for (let i = 364; i >= 0; i--) {
            const d = new Date(hoy);
            d.setDate(hoy.getDate() - i);
            const f = d.toISOString().slice(0,10);
            fechas.push(f);
            counts[f] = 0;
        }

        incidentes.forEach(inc => {
            if (counts[inc.fecha] !== undefined) counts[inc.fecha]++;
        });

        const data = fechas.map(f => counts[f]);

        if (chartRef) chartRef.destroy();

        const ctx = document.getElementById(canvasId).getContext('2d');
        const newChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: fechas,
                datasets: [{
                    label: 'Incidentes',
                    data,
                    backgroundColor: data.map(v => v >= indicadorSeleccionado.umbral_rojo ? '#f8d7da' :
                        v >= indicadorSeleccionado.umbral_amarillo ? '#fff3cd' : '#d4edda'),
                    borderColor: data.map(v => v >= indicadorSeleccionado.umbral_rojo ? '#dc3545' :
                        v >= indicadorSeleccionado.umbral_amarillo ? '#ffc107' : '#28a745'),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    datalabels: { display: false }
                },
                scales: {
                    x: { ticks: { maxTicksLimit: 12, maxRotation: 45 } },
                    y: { beginAtZero: true, ticks: { stepSize: 1 } }
                }
            }
        });
        setChart(newChart);
    }

    function colorCelda(count, ind) {
        if (count >= ind.umbral_rojo) return 'celda-roja';
        if (count >= ind.umbral_amarillo) return 'celda-amarilla';
        return 'celda-verde';
    }

    function ultimasNSemanas(n) {
        const semanas = [];
        let sem = getSemanaActual();
        let anio = new Date().getFullYear();
        for (let i = 0; i < n; i++) {
            semanas.unshift(`${anio}-W${String(sem).padStart(2,'0')}`);
            sem--;
            if (sem < 1) {
                anio--;
                sem = semanasEnAnio(anio);
            }
        }
        return semanas;
    }

    function obtenerDiasDeSemana(isoWeek) {
        const [anio, semStr] = isoWeek.split('-W');
        const sem = parseInt(semStr);
        const jan4 = new Date(parseInt(anio), 0, 4);
        const startOfWeek1 = new Date(jan4);
        startOfWeek1.setDate(jan4.getDate() - ((jan4.getDay() + 6) % 7));
        const lunes = new Date(startOfWeek1);
        lunes.setDate(startOfWeek1.getDate() + (sem - 1) * 7);
        const dias = [];
        for (let i = 0; i < 7; i++) {
            const d = new Date(lunes);
            d.setDate(lunes.getDate() + i);
            dias.push(d.toISOString().slice(0,10));
        }
        return dias;
    }

    window.recargarNivel1 = function() {
        cargarDatosClustering();
    }

    window.recargarNivel2 = function() {
        if (centroActivoClust) mostrarNivel2(centroActivoClust);
    }

    window.volverNivel1 = function() {
        document.getElementById('cardNivel2').classList.add('hidden');
        document.getElementById('cardNivel3').classList.add('hidden');
        document.getElementById('cardNivel1').scrollIntoView({ behavior: 'smooth' });
    }

    window.volverNivel2 = function() {
        document.getElementById('cardNivel3').classList.add('hidden');
        document.getElementById('cardNivel2').scrollIntoView({ behavior: 'smooth' });
    }

    // ‚îÄ‚îÄ‚îÄ DESCARGAR GR√ÅFICO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.descargarGrafico = function() {
        if (!pbcChart) return;
        const link = document.createElement('a');
        link.download = `${indicadorSeleccionado?.nombre || 'grafico'}.png`;
        link.href = pbcChart.toBase64Image('image/png', 1.0);
        link.click();
    }

    // ‚îÄ‚îÄ‚îÄ CERRAR SESI√ìN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    window.cerrarSesion = async function() {
        await signOut(auth);
        sessionStorage.clear();
        window.location.href = 'login.html';
    }

    // ‚îÄ‚îÄ‚îÄ INICIALIZACI√ìN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    onAuthStateChanged(auth, async user => {
        if (!user) {
            window.location.href = 'login.html';
            return;
        }

        const usuario = JSON.parse(sessionStorage.getItem('usuario') || '{}');
        if (!usuario.uid) {
            window.location.href = 'login.html';
            return;
        }
        if (usuario.nombre) {
            document.getElementById('headerSubtitle').textContent = `Bienvenido, ${usuario.nombre}`;
        }

        if (usuario.rol === 'operador') {
            const sel = document.getElementById('selCentro');
            sel.value = usuario.centro_id;
            sel.disabled = true;
        }

        const semActual = getSemanaActual();
        const anioActual = new Date().getFullYear();
        const semDesde = semActual > 24 ? semActual - 24 : 1;

        poblarSemanas('selSemanaDesde', semDesde);
        poblarSemanas('selSemanaHasta', semActual);
        document.getElementById('inputAnioDesde').value = anioActual;
        document.getElementById('inputAnioHasta').value = anioActual;

        

        await cargarRedes();
        await cargarCentros();
        await cargarIndicadores();
    });
</script>
</body>
</html>
